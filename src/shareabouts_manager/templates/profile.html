{% extends 'manager-base.html' %}

{% block main %}

<section class="main">
  <div class="container">
    {% if form.errors.email %}
    <div class="alert alert-error"><strong>{{ form.errors.email.as_text|slice:"2:"|safe }}</strong></div>
    {% endif %}

    <h3>My Account</h3>
    <form method="POST">
      {% csrf_token %}

      <p><input required type="email" name="email" id="email-address" class="input-block" placeholder="email@example.org" tabindex="1" value="{{ profile.email|default_if_none:'' }}"> <label for="my-email" class="float-label"><strong>Email</strong></label></p>

      <p><input required type="text" name="affiliation" id="affiliation" class="input-block" placeholder="Organizational Affiliation" max="256" tabindex="4" value="{{ profile.affiliation|default_if_none:'' }}"> <label for="affiliation" class="float-label"><strong>Organizational Affiliation</strong></label></p>

      <p class="clearfix">
        {% for package in packages %}
        <input class="radio-btn is-visuallyhidden" type="radio" name="package" id="plan-{{ package.slug }}" value="{{ package.slug }}"{% if profile.package.slug == package.slug %} checked="checked"{% endif %}{% if not profile.can_pay and package.price > 0 %}disabled="disabled" {% endif %} />
        <label for="plan-{{ package.slug }}" class="plan-btn">
          <strong class="plan-title">{{ package.name }}</strong>
          <span class="plan-price">
            {% if package.price == 0 %}
            (<span class="price">Free</span>)
            {% else %}
            (<span class="unit">$</span><span class="price">{{ package.price }}</span><small class="frequency">/month</small>)
            {% endif %}
          </span>
        </label>
        {% endfor %}
      </p>  

      <p>
        {% if not profile.can_pay %}
        Please enter payment information below to upgrade your plan.
        {% endif %}
      </p>     

      <p><input type="submit" value="Update Account" class="btn btn-large" tabindex="4"></p>
    </form>

    <hr>

    <h3>Payment Method</h3>
    {% if profile.credit_card %}
    <p class="payment-method"><span class="card-number">**** **** **** {{ profile.credit_card.four }}</span> <span class="card-type">{{ profile.credit_card.type }}</span> <button id="set-credit-card" class="btn btn-small">Change</button></p>
    {% else %}
    <p class="payment-method"><button id="set-credit-card" class="btn btn-small">Add a Credit Card</button></p>
    {% endif %}

  </div>
</section>

{% endblock %}

{% block scripts %}
  <script src="https://checkout.stripe.com/checkout.js"></script>

  <script>
    var stripeHandler = StripeCheckout.configure({
      key: '{{ settings.STRIPE_PUBLIC_KEY }}',
      token: function(token, args) {
        // Use the token to create the charge with a server-side script.
        // You can access the token ID with `token.id`
      }
    });

    document.getElementById('set-credit-card').addEventListener('click', function(e) {
      stripeHandler.open({
        name: 'Shareabouts',
        description: '...',
        amount: 2000
      });
      e.preventDefault();
    });
  </script>

  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <script>
    Stripe.setPublishableKey('{{ settings.STRIPE_PUBLIC_KEY }}');
  </script>
{% endblock %}